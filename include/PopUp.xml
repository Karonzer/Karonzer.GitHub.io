<krpano popupName = "" currentPopUpIndex = "" popupImageCount = "" dragitem="null" >

  <!-- Web -->
  <!-- 팝업 부모 레이어, 배경 레이어 -->
  <layer name="layer_parent" type="image" alpha="0.0" zorder="20" align="center" onclick="layer_off();" visible="false" keep="true" />
  <layer name="layer_bg" type="container" width="100%" height="100%" alpha="1.0" bgcapture="true" zorder="15" align="center" bgcolor="0x000000" bgalpha="0.7" onclick="layer_off();" visible="false" keep="true" enabled="true" />

  <!-- popup layers -->
  <layer name="popup_bg" type="container" width="100%" height="100%" alpha="1.0" bgcapture="true" zorder="15" align="center" bgcolor="0x000000" bgalpha="0.7" onclick="close_popup();" visible="false" keep="true" enabled="true" />
 <!-- 0601수정_팝업 화살표 디자인 변경에 따른 크기, 위치 수정함.  -->
  <!-- <layer name="popup" type="image" alpha="0.0" zorder="20" align="center" onclick="close_popup();" visible="false" keep="true" scalechildren="true" x="4" scale = "0.90"/>-->
	<layer name="popup" type="image" alpha="0.0" zorder="20" align="center" onclick="close_popup();" visible="false" keep="true" scalechildren="true" x="4" scale = "0.90" ondown="draglayer" onUp ="TestOnUp"/>
  <layer name="popup_soundOn" url="%FIRSTXML%/source/common/btn/btn_sound_off.png" keep="true" parent="popup" align="lefttop" edge="bottom" handcursor="true" x="130" y="610" zorder="10" onclick="play_voice();" alpha="0.0" visible ="false" />
  <layer name="popup_soundOff" url="%FIRSTXML%/source/common/btn/btn_sound_on.png" keep="true" parent="popup" align="lefttop" edge="bottom" handcursor="true" x="130" y="610" zorder="10" onclick="stop_voice();" visible ="false" />
  <layer name="popup_btn_left" url="%FIRSTXML%/source/common/btn/btn_popup_left.png" keep="true" parent="popup" align="left" edge="middle" handcursor="true"  zorder="5" x ="-18" onclick="change_popup(left);" alpha="0.0" visible ="false" />
  <layer name="popup_btn_right" url="%FIRSTXML%/source/common/btn/btn_popup_right.png" keep="true" parent="popup" align="right" edge="middle" handcursor="true" zorder="5" x ="-10" onclick="change_popup(right);" alpha="0.0" visible ="false" />
	<layer name="popup_close" url="%FIRSTXML%/source/common/btn/close.png" keep="true" parent="popup" align="lefttop" edge="bottom" handcursor="true" x="880" y="105" zorder="10" onclick="close_popup();" alpha="0.0" visible ="false" />

	<layer name="drag_1_drop" url="%FIRSTXML%/source/common/btn/btn_sound_off.png" alpha="1" zorder="20" align="center" visible="false" keep="true" scalechildren="true" x="100" y="100" scale = "0.90"/>
	<layer name="drag_2_drop" url="%FIRSTXML%/source/common/btn/btn_sound_off.png" alpha="1" zorder="20" align="center" visible="false" keep="true" scalechildren="true" x="100" y="200" scale = "0.90"/>
	<layer name="drag_3_drop" url="%FIRSTXML%/source/common/btn/btn_sound_off.png" alpha="1" zorder="20" align="center" visible="false" keep="true" scalechildren="true" x="100" y="300" scale = "0.90"/>
	
	<layer name="drag_1" url="%FIRSTXML%/source/common/btn/btn_sound_off.png" alpha="1" zorder="20" align="center" visible="false" keep="true" scalechildren="true" x="-100" y="100" scale = "0.90" ondown="draglayer(drag_1)" onUp ="TestOnUp(drag_1)"/>
	<layer name="drag_2" url="%FIRSTXML%/source/common/btn/btn_sound_off.png" alpha="1" zorder="20" align="center" visible="false" keep="true" scalechildren="true" x="-100" y="200" scale = "0.90" ondown="draglayer(drag_2)" onUp ="TestOnUp(drag_2)"/>
	<layer name="drag_3" url="%FIRSTXML%/source/common/btn/btn_sound_off.png" alpha="1" zorder="20" align="center" visible="false" keep="true" scalechildren="true" x="-100" y="300" scale = "0.90" ondown="draglayer(drag_3)" onUp ="TestOnUp(drag_3)"/>

	<!-- open popup -->
  <action name="open_popup">
	  set(popupName, %1);
	  set(currentPopUpIndex, 1);
	  if(%2 != null, set(popupImageCount, %2);
	  , set(popupImageCount, 1);
	  );
	  set(layer[popup].url, calc: "source/ty_hsd/popup/" + popupName + "_" + currentPopUpIndex + ".png");
	  set(layer[popup].x ,calc : 4);
	  set(voicepath, calc: currentscene + "/audio/" + popupName + "_" + currentPopUpIndex + ".mp3|" + popupName + "_" + currentPopUpIndex +".ogg");
	  Playeffect("bubble");
	  popup_size();

	  delayedcall(0.1, set(layer[popup_bg].visible,true));
	  delayedcall(0.1, tween(layer[popup_bg].alpha,  1.0, 0.3));
	  delayedcall(0.1, set(layer[popup].visible,true));
	  delayedcall(0.1, tween(layer[popup].alpha,  1.0, 0.3));

	  delayedcall(0.1, set(layer[popup_soundOn].visible,true));
	  delayedcall(0.1, tween(layer[popup_soundOn].alpha,  1.0, 0.3));

	  if(popupName == "ty_hsd_15_i1",
	  delayedcall(0.1, set(layer[popup_close].visible,false));
	  delayedcall(0.1, tween(layer[popup_close].alpha,  1.0, 0.3));
	  ,
	  delayedcall(0.1, set(layer[popup_close].visible,true));
	  delayedcall(0.1, tween(layer[popup_close].alpha,  1.0, 0.3));
	  );

	  if(popupName == "ty_hsd_12_i1" OR popupName == "ty_hsd_1_i1",
	  delayedcall(0.1, set(layer[popup_soundOn].visible,false));
	  delayedcall(0.1, tween(layer[popup_soundOn].alpha,  1.0, 0.3));
	  set(layer[popup_close].width, 40);
	  set(layer[popup_close].height, 33);
	  ,
	  delayedcall(0.1, set(layer[popup_soundOn].visible,true));
	  delayedcall(0.1, tween(layer[popup_soundOn].alpha,  1.0, 0.3));
	  set(layer[popup_close].width, 40);
	  set(layer[popup_close].height, 40);
	  );

	  if(currentPopUpIndex == popupImageCount,
	  delayedcall(0.1, set(layer[popup_btn_left].visible,false));
	  delayedcall(0.1, set(layer[popup_btn_right].visible,false));
	  ,
	  delayedcall(0.1, set(layer[popup_btn_left].visible,false));
	  delayedcall(0.1, set(layer[popup_btn_right].visible,true));
	  delayedcall(0.1, tween(layer[popup_btn_right].alpha,  1.0, 0.3));
	  );

	  autorotate.pause();
  </action>


  <!-- change_popup -->
  <action name="change_popup">
	  set(layer[popup].alpha,  0.0);
	  set(layer[popup].visible,false);
	  
	<!--  stop_voice(); -->

	  set(layer[popup_soundOn].alpha,  0.0);
	  set(layer[popup_soundOn].visible,false);

	  if(%1 == "right", inc(currentPopUpIndex);
	  delayedcall(0.1, set(layer[popup_btn_left].visible,true));
	  delayedcall(0.1, tween(layer[popup_btn_left].alpha,  1.0, 0.3));

	  if(currentPopUpIndex == popupImageCount,
	  delayedcall(0.1, set(layer[popup_btn_right].visible,false));  );
	  ,
	  dec(currentPopUpIndex);
	  delayedcall(0.1, set(layer[popup_btn_right].visible,true));
	  delayedcall(0.1, tween(layer[popup_btn_right].alpha,  1.0, 0.3));

	  if(currentPopUpIndex == 1,
	  delayedcall(0.1, set(layer[popup_btn_left].visible,false));  );
	  );

	  set(layer[popup].url, calc: "source/ty_hsd/popup/" + popupName + "_" + currentPopUpIndex + ".png");
	 <!-- set(voicepath, calc: currentscene + "/audio/" + popupName + "_" + currentPopUpIndex + ".mp3|" + popupName + "_" + currentPopUpIndex +".ogg"); -->
	  set(voicepath, calc: currentscene + "/audio/" + popupName + "_" + 1 + ".mp3|" + popupName + "_" + 1 +".ogg");
	  Playeffect("bubble");

	  popup_size();
	  delayedcall(0.1, set(layer[popup_bg].visible,true));
	  delayedcall(0.1, tween(layer[popup_bg].alpha,  1.0, 0.3));
	  delayedcall(0.1, set(layer[popup].visible,true));
	  delayedcall(0.1, tween(layer[popup].alpha,  1.0, 0.3));
	  delayedcall(0.1, set(layer[popup_soundOn].visible,true));
	  delayedcall(0.1, tween(layer[popup_soundOn].alpha,  1.0, 0.3));


	  if(popupName == "ty_hsd_1_i1" OR  popupName == "ty_hsd_12_i1",
	  delayedcall(0.1, set(layer[popup_soundOn].visible,false));
	  delayedcall(0.1, tween(layer[popup_soundOn].alpha,  1.0, 0.3));
	  ,
	  delayedcall(0.1, set(layer[popup_soundOn].visible,true));
	  delayedcall(0.1, tween(layer[popup_soundOn].alpha,  1.0, 0.3));
	  );

	  autorotate.pause();
  </action>

  <!-- set up popup size -->
  <action name="popup_size">
	  set(layer[popup].width, 1000);
	  set(layer[popup].height, 909);
	  calc(popupratio, layer[popup].width/layer[popup].height);
	  if( stagewidth/stageheight GE popupratio,
	  calc(layer[popup].height, stageheight);
	  calc(layer[popup].width, layer[popup].height * popupratio);

	  , calc(layer[popup].width, stagewidth);
	  calc(layer[popup].height, layer[popup].width / popupratio);
	  );
  </action>

	


  <!-- close popup -->
  <action name="close_popup">
  	set(layer[popup_bg].alpha,  0.0);
  	set(layer[popup_bg].visible,false);
  	set(layer[popup].alpha,  0.0);
  	set(layer[popup].visible,false);
  	stop_voice();
  	set(layer[popup_soundOn].alpha,  0.0);
  	set(layer[popup_soundOn].visible,false);
  	autorotate.resume();
  </action>

  <!-- VR -->

  <!-- vr description hotspot style -->
  <style name="btn_description_vr" url="%FIRSTXML%/source/common/btn/btn_description.png" scale="0.6" scale.mobile="0.4" zorder="1" zoom="false" distorted="false" visible="false" />
  <style name="popup_window_vr" zorder="2" zoom="false" distorted="true" handcursor="false" visible="false" />
  <style name="popup_close_btn_vr" url="%FIRSTXML%/source/common/btn/close.png" zorder="3" zoom="false"  visible ="false" distorted="false"/>
  <style name="popup_soundOn_vr" url="%FIRSTXML%/source/common/btn/btn_sound_off.png" zorder="3" onclick="play_voice_vr();" zoom="false" visible ="false" distorted="false" />
  <style name="popup_soundOff_vr" url="%FIRSTXML%/source/common/btn/btn_sound_on.png" zorder="3" onclick="stop_voice_vr();" zoom="false" visible ="false" distorted="false" />
  <style name="popup_btn_left_vr" url="%FIRSTXML%/source/common/btn/btn_popup_left.png" zorder="3" onclick="change_popup_vr(left);" zoom="false" visible ="false" distorted="false" />
  <style name="popup_btn_right_vr" url="%FIRSTXML%/source/common/btn/btn_popup_right.png" zorder="3" onclick="change_popup_vr(right);" zoom="false" visible ="false" distorted="false" />

  <!-- open vr mode popup -->
  <action name="open_popup_vr">
	  set(popupName, %1);
	  set(currentPopUpIndex, 1);
	  if(%2 != null, set(popupImageCount, %2);
	  , set(popupImageCount, 1);
	  );
	  set(hotspot[popup_vr].url, calc: "source/"+ currentscene + "/popup/" + popupName + "_" + currentPopUpIndex + ".png");
	  set(voicepath, calc: currentscene + "/audio/" + popupName + "_" + currentPopUpIndex + ".mp3|" + popupName + "_" + currentPopUpIndex +".ogg");
	  Playeffect("bubble");
	  set(popupvr, calc: "%1" + "_vr");
	  set(hotspot[popup_vr].ath, get(hotspot[get(popupvr)].ath));

	  popupbtn_pos();

	  set(hotspot[popup_vr].visible,true);
	  set(hotspot[popup_close_btn_vr].visible,true);

	  if(currentPopUpIndex == popupImageCount,
	  set(hotspot[popup_btn_left_vr].visible,false);
	  set(hotspot[popup_btn_right_vr].visible,false);
	  ,
	  set(hotspot[popup_btn_left_vr].visible,false);
	  set(hotspot[popup_btn_right_vr].visible,true);
	  );

	  check_popupSound_vr();

  </action>

	<action name="check_popupSound_vr">
		if(popupName == "ty_hsd_1_i1" OR  popupName == "ty_hsd_12_i1",
		set(layer[popup_soundOn_vr].visible,false);
		set(layer[popup_soundOff_vr].visible,false);
		,
		set(layer[popup_soundOff_vr].visible,true);
		play_voice_vr();
		);
	</action>

	<action name ="popupbtn_pos">
		<!-- 줄 없음 -->
		if(popupName == "ty_hsd_1_i1" OR  popupName == "ty_hsd_12_i1",
		set(hotspot[popup_close_btn_vr].ath, 28);
		set(hotspot[popup_close_btn_vr].atv, -18);
		);

		<!--한 줄-->
		if(popupName == "ty_hsd_9_i1" OR popupName == "ty_hsd_11_i3",
		set(hotspot[popup_close_btn_vr].ath, 28);
		set(hotspot[popup_close_btn_vr].atv, -21);

		set(hotspot[popup_soundOn_vr].atv, 11.5);
		set(hotspot[popup_soundOff_vr].atv, 11.5);
		);

		<!--둘 줄-->
		if(popupName == "ty_hsd_3_i1" OR popupName == "ty_hsd_11_i1" OR popupName == "ty_hsd_11_i2" OR popupName == "ty_hsd_11_i6" OR popupName  == "ty_hsd_11_i4",
		set(hotspot[popup_close_btn_vr].ath, 28);
		set(hotspot[popup_close_btn_vr].atv, -22.5);

		set(hotspot[popup_soundOn_vr].atv, 9.5);
		set(hotspot[popup_soundOff_vr].atv, 9.5);

		);

		<!--셋 줄-->
		if(popupName == "ty_hsd_2_i1" OR popupName == "ty_hsd_6_i1" OR popupName == "ty_hsd_7_i1" OR popupName == "ty_hsd_8_i1" OR popupName == "ty_hsd_10_i1" OR popupName == "ty_hsd_11_i5",
		set(hotspot[popup_close_btn_vr].ath, 28);
		set(hotspot[popup_close_btn_vr].atv, -24);

		set(hotspot[popup_soundOn_vr].atv, 7.5);
		set(hotspot[popup_soundOff_vr].atv, 7.5);

		);

		<!--넷 줄-->
		if(popupName == "ty_hsd_2_i2" OR popupName == "ty_hsd_2_i3",
		set(hotspot[popup_close_btn_vr].ath, 28);
		set(hotspot[popup_close_btn_vr].atv, -26);

		set(hotspot[popup_soundOn_vr].atv, 6);
		set(hotspot[popup_soundOff_vr].atv, 6);

		);

		<!--다섯 줄-->
		if(popupName == "ty_hsd_5_i1" OR popupName == "ty_hsd_14_i1",
		set(hotspot[popup_close_btn_vr].ath, 28);
		set(hotspot[popup_close_btn_vr].atv, -27);

		set(hotspot[popup_soundOn_vr].ath, 0);
		set(hotspot[popup_soundOff_vr].ath, 0);
		);

		set(hotspot[popup_soundOn_vr].ath, -28);
		set(hotspot[popup_soundOff_vr].ath, -28);

		set(hotspot[popup_btn_left_vr].ath, -45);
		set(hotspot[popup_btn_right_vr].ath, 45);

	</action>
	
  <action name="change_popup_vr">
   <!-- stop_voice_vr(); -->
    if(%1 == "right", inc(currentPopUpIndex);
      set(hotspot[popup_btn_left_vr].visible,true);

    if(currentPopUpIndex == popupImageCount,
      set(hotspot[popup_btn_right_vr].visible,false); );
    ,
      dec(currentPopUpIndex);
      set(hotspot[popup_btn_right_vr].visible,true);

      if(currentPopUpIndex == 1,
      set(hotspot[popup_btn_left_vr].visible,false);  );
    );

    set(hotspot[popup_vr].url, calc: "source/"+ currentscene + "/popup/" + popupName + "_" + currentPopUpIndex + ".png");
    <!-- set(voicepath, calc: currentscene + "/audio/" + popupName + "_" + currentPopUpIndex + ".mp3|" + popupName + "_" + currentPopUpIndex +".ogg"); -->
	  Playeffect("bubble");

	  set(hotspot[popup_vr].visible,true);
	  set(hotspot[popup_close_btn_vr].visible,true);
	  set(layer[popup_soundOff_vr].visible,true);
	  <!-- play_voice_vr(); -->
  </action>

  <!-- close popup -->
  <action name="close_popup_vr">
  	stop_voice_vr();
    set(hotspot[popup_vr].visible,false);
  	set(hotspot[popup_close_btn_vr].visible,false);
    set(hotspot[popup_soundOn_vr].visible,false);
    set(hotspot[popup_soundOff_vr].visible,false);
    set(hotspot[popup_btn_left_vr].visible,false);
    set(hotspot[popup_btn_right_vr].visible,false);
  	autorotate.resume();
  </action>

  <!-- popup vr off if visible is true -->
  	<action name="popup_vr_off">
    <!-- 		stopsound("recodingVoice"); -->
  		if(hotspot[popup_vr].visible == true,
  				close_popup_vr();
  		);
  	</action>


	<action name="draglayer">
		copy(drag_currentx, x);
		copy(drag_currenty, y);
		copy(drag_stagex, mouse.stagex);
		copy(drag_stagey, mouse.stagey);
		indexoftxt(align_contains_right, get(align), 'right');
		indexoftxt(align_contains_bottom, get(align), 'bottom');
		calc(drag_align_x, align_contains_right GE 0 ? -1 : +1);
		calc(drag_align_y, align_contains_bottom GE 0 ? -1 : +1);
		asyncloop(pressed,
		calc(x, drag_currentx + (mouse.stagex - drag_stagex)*drag_align_x);
		calc(y, drag_currenty + (mouse.stagey - drag_stagey)*drag_align_y);
		);

		set(dragitem, %1);
	</action>

	<action name="TestOnUp">

		txtadd(check, get(dragitem), "_drop");

		set(dropcehck_left, get(layer[get(check)].x));
		set(dropcehck_right, get(layer[get(check)].x));
		set(dropcehck_Up, get(layer[get(check)].y));
		set(dropcehck_Down, get(layer[get(check)].y));

		sub(dropcehck_left, 10);
		add(dropcehck_right, 10);
		sub(dropcehck_Up, 10);
		add(dropcehck_Down, 10);

		trace(dropcehck_left);
		trace(dropcehck_right);
		trace(dropcehck_Up);
		trace(dropcehck_Down);

		if(get(layer[get(dragitem)].x) GE dropcehck_left AND get(layer[get(dragitem)].x) LE dropcehck_right AND
		get(layer[get(dragitem)].y) GE dropcehck_Up AND get(layer[get(dragitem)].y) LE dropcehck_Down,
		trace('드롭 성공!');
		//
		change_drop(check,dragitem);
		set(layer[get(dragitem)].visible,false)
		,
		trace('드롭 실패.');
		// 드롭 실패 시의 추가 액션
		);

		set(dragitem,"null")

		trace(dragitem);// 드래그하는 물체 초기화
	</action>
	
	<action name ="change_drop">
		trace("change_drop");
		set(layer[get(%1)].url, get(layer[get(%2)].url));
		Playeffect("bubble");
	</action>



	<action name="test_open_popup">
		set(popupName, %1);
		set(currentPopUpIndex, 1);
		if(%2 != null, set(popupImageCount, %2);
		, set(popupImageCount, 1);
		);
		set(layer[popup].url, calc: "source/ty_hsd/popup/" + popupName + "_" + currentPopUpIndex + ".png");
		set(layer[popup].x ,calc : 4);
		set(voicepath, calc: currentscene + "/audio/" + popupName + "_" + currentPopUpIndex + ".mp3|" + popupName + "_" + currentPopUpIndex +".ogg");
		Playeffect("bubble");
		popup_size();

		delayedcall(0.1, set(layer[drag_1].visible,true));
		delayedcall(0.1, set(layer[drag_1_drop].visible,true));

		delayedcall(0.1, set(layer[drag_2].visible,true));
		delayedcall(0.1, set(layer[drag_2_drop].visible,true));

		delayedcall(0.1, set(layer[drag_3].visible,true));
		delayedcall(0.1, set(layer[drag_3_drop].visible,true));

		set(layer[drag_1].url, calc: "%FIRSTXML%/source/common/btn/close.png");
		set(layer[drag_2].url, calc: "%FIRSTXML%/source/common/btn/close.png");
		set(layer[drag_3].url, calc: "%FIRSTXML%/source/common/btn/close.png");

		delayedcall(0.1, set(layer[popup_bg].visible,true));
		delayedcall(0.1, tween(layer[popup_bg].alpha,  1.0, 0.3));
		delayedcall(0.1, set(layer[popup].visible,false));
		delayedcall(0.1, tween(layer[popup].alpha,  1.0, 0.3));

		delayedcall(0.1, set(layer[popup_soundOn].visible,true));
		delayedcall(0.1, tween(layer[popup_soundOn].alpha,  1.0, 0.3));

		if(popupName == "ty_hsd_15_i1",
		delayedcall(0.1, set(layer[popup_close].visible,false));
		delayedcall(0.1, tween(layer[popup_close].alpha,  1.0, 0.3));
		,
		delayedcall(0.1, set(layer[popup_close].visible,true));
		delayedcall(0.1, tween(layer[popup_close].alpha,  1.0, 0.3));
		);

		if(popupName == "ty_hsd_12_i1" OR popupName == "ty_hsd_1_i1",
		delayedcall(0.1, set(layer[popup_soundOn].visible,false));
		delayedcall(0.1, tween(layer[popup_soundOn].alpha,  1.0, 0.3));
		set(layer[popup_close].width, 40);
		set(layer[popup_close].height, 33);
		,
		delayedcall(0.1, set(layer[popup_soundOn].visible,true));
		delayedcall(0.1, tween(layer[popup_soundOn].alpha,  1.0, 0.3));
		set(layer[popup_close].width, 40);
		set(layer[popup_close].height, 40);
		);

		if(currentPopUpIndex == popupImageCount,
		delayedcall(0.1, set(layer[popup_btn_left].visible,false));
		delayedcall(0.1, set(layer[popup_btn_right].visible,false));
		,
		delayedcall(0.1, set(layer[popup_btn_left].visible,false));
		delayedcall(0.1, set(layer[popup_btn_right].visible,true));
		delayedcall(0.1, tween(layer[popup_btn_right].alpha,  1.0, 0.3));
		);
		trace("test_open_popup");
		autorotate.pause();
	</action>

</krpano>
